let inputUrlFragmentPlaceholder=chrome.i18n.getMessage("inputUrlFragmentPlaceholder"),inputUrlFragmentRegExpPlaceholder=chrome.i18n.getMessage("inputUrlFragmentRegExpPlaceholder"),inputColorPlaceholder=chrome.i18n.getMessage("inputColorPlaceholder"),inputLabelPlaceholder=chrome.i18n.getMessage("inputLabelPlaceholder"),selectFontSizeLabel=chrome.i18n.getMessage("selectFontSizeLabel"),selectPositionLabel=chrome.i18n.getMessage("selectPositionLabel"),selectRibbonSizeLabel=chrome.i18n.getMessage("inputLabelPlaceholder"),buttonSaveLabel=chrome.i18n.getMessage("buttonSaveLabel"),positionSelectTopLeft=chrome.i18n.getMessage("positionSelectTopLeft"),positionSelectTopRight=chrome.i18n.getMessage("positionSelectTopRight"),positionSelectBottomLeft=chrome.i18n.getMessage("positionSelectBottomLeft"),positionSelectBottomRight=chrome.i18n.getMessage("positionSelectBottomRight"),sizeSelectExtraSmall=chrome.i18n.getMessage("sizeSelectExtraSmall"),sizeSelectSmall=chrome.i18n.getMessage("sizeSelectSmall"),sizeSelectNormal=chrome.i18n.getMessage("sizeSelectNormal"),sizeSelectLarge=chrome.i18n.getMessage("sizeSelectLarge"),sizeSelectExtraLarge=chrome.i18n.getMessage("sizeSelectExtraLarge"),noticeNoRibbons=chrome.i18n.getMessage("noticeNoRibbons"),buttonClearAll=chrome.i18n.getMessage("buttonClearAll"),buttonDisable=chrome.i18n.getMessage("buttonDisable"),buttonEnable=chrome.i18n.getMessage("buttonEnable"),buttonOptions=chrome.i18n.getMessage("buttonOptions"),errorDuplicateMarker=chrome.i18n.getMessage("errorDuplicateMarker"),errorLabelEmpty=chrome.i18n.getMessage("errorLabelEmpty"),errorUrlEmpty=chrome.i18n.getMessage("errorUrlEmpty"),colorPickerUiDialog=chrome.i18n.getMessage("colorPickerUiDialog"),colorPickerBtnToggle=chrome.i18n.getMessage("colorPickerBtnToggle"),colorPickerBtnSwatch=chrome.i18n.getMessage("colorPickerBtnSwatch"),colorPickerBtnLastColor=chrome.i18n.getMessage("colorPickerBtnLastColor"),colorPickerBtnSave=chrome.i18n.getMessage("colorPickerBtnSave"),colorPickerBtnCancel=chrome.i18n.getMessage("colorPickerBtnCancel"),colorPickerBtnClear=chrome.i18n.getMessage("colorPickerBtnClear"),colorPickerAriaBtnSave=chrome.i18n.getMessage("colorPickerAriaBtnSave"),colorPickerAriaBtnCancel=chrome.i18n.getMessage("colorPickerAriaBtnCancel"),colorPickerAriaBtnClear=chrome.i18n.getMessage("colorPickerAriaBtnClear"),colorPickerAriaInput=chrome.i18n.getMessage("colorPickerAriaInput"),colorPickerAriaPalette=chrome.i18n.getMessage("colorPickerAriaPalette"),colorPickerAriaHue=chrome.i18n.getMessage("colorPickerAriaHue"),colorPickerAriaOpacity=chrome.i18n.getMessage("colorPickerAriaOpacity"),displayAt=chrome.i18n.getMessage("displayAt"),ariaLabelEditRibbon=chrome.i18n.getMessage("ariaLabelEditRibbon"),ariaLabelDeleteRibbon=chrome.i18n.getMessage("ariaLabelDeleteRibbon"),ariaLabelAlertClose=chrome.i18n.getMessage("ariaLabelAlertClose"),languageCode=chrome.i18n.getUILanguage(),pickr=null,colorSwatches=["rgba(244, 67,  54, 1)","rgba(233, 30,  99, 1)","rgba(156, 39, 176, 1)","rgba(103, 58, 183, 1)","rgba(63,  81, 181, 1)","rgba(33, 150, 243, 1)","rgba(3,  169, 244, 1)"];const extensionEnabledKey="__em-enabled__",swatchesKey="__em-swatches__",markersKey="__em-markers__",dbVersionKey="__em-version__",searchModeKey="__em-search-mode__",maxSwatches=7,hide="none",show="block",fontSizeMap=[{value:"10",label:"10px"},{value:"12",label:"12px"},{value:"14",label:"14px"},{value:"16",label:"16px"},{value:"18",label:"18px"}],positionsMap=[{value:"top-left",label:positionSelectTopLeft},{value:"top-right",label:positionSelectTopRight},{value:"bottom-left",label:positionSelectBottomLeft},{value:"bottom-right",label:positionSelectBottomRight}],sizesMap=[{value:"extra-small",label:sizeSelectExtraSmall},{value:"small",label:sizeSelectSmall},{value:"normal",label:sizeSelectNormal},{value:"large",label:sizeSelectLarge},{value:"extra-large",label:sizeSelectExtraLarge}];function onError(e){console.log(e)}function truncateString(e,t){return e.length<=t?e:e.slice(0,t)+"..."}function versionCompare(e,t,a){var r=a&&a.lexicographical,o=a&&a.zeroExtend,l=e.split("."),i=t.split(".");function n(e){return(r?/^\d+[A-Za-z]*$/:/^\d+$/).test(e)}if(!l.every(n)||!i.every(n))return NaN;if(o){for(;l.length<i.length;)l.push("0");for(;i.length<l.length;)i.push("0")}r||(l=l.map(Number),i=i.map(Number));for(var s=0;s<l.length;++s){if(i.length==s)return 1;if(l[s]!=i[s])return l[s]>i[s]?1:-1}return l.length!=i.length?-1:0}function initialize(){chrome.storage.sync.get(dbVersionKey).then((e=>{let t=e[dbVersionKey]||"",a=chrome.runtime.getManifest().version;""===t?chrome.storage.sync.get(null).then((e=>{let t=Object.keys(e);if(t.length>0){let r=[];for(let a of t){let t={settingUrl:a,settingColor:e[a][0],settingLabel:e[a][1],settingPosition:e[a][2],settingSize:e[a][3],settingFontSize:e[a][4]};r.push(t)}chrome.storage.sync.clear().then((()=>{chrome.storage.sync.set({[markersKey]:r}).then((()=>{chrome.storage.sync.set({[dbVersionKey]:a}).then((()=>{initializeDisplay()}),onError)}),onError)}))}else chrome.storage.sync.set({[dbVersionKey]:a}).then((()=>{initializeDisplay()}),onError)}),onError):versionCompare(a,t,{zeroExtend:!0})>0?chrome.storage.sync.set({[dbVersionKey]:a}).then((()=>{initializeDisplay()}),onError):initializeDisplay()}),onError)}function initializeDisplay(){chrome.storage.sync.get(markersKey).then((e=>{let t=e[markersKey]||[];if(t.length>0){$(".setting").remove(),showOrHideEmptyNotice(hide);for(let e in t)displaySetting(e,t[e].settingUrl,t[e].settingColor,t[e].settingLabel,t[e].settingPosition,t[e].settingSize,t[e].settingFontSize)}else showOrHideEmptyNotice(show)}),onError)}function showOrHideEmptyNotice(e=null){null===e?initializeDisplay():$(".empty-notice").css("display",e)}function saveSwatches(e){chrome.storage.sync.set({[swatchesKey]:e}).then(null,onError)}function showMessage(e,t=!1){let a=t?"alert-danger":"alert-success";$(".alert-dismissible").length&&$(".alert-dismissible").alert("close"),$(".outer-wrapper .message-container").append('<div class="alert '+a+' alert-dismissible fade show col-12" role="alert">'+e+'<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="'+ariaLabelAlertClose+'"></button></div>'),window.setTimeout((function(){$(".alert-dismissible").alert("close")}),3e3)}function searchStoredMarkers(e,t,a=null){a&&(a=Number(a));for(let r=0;r<t.length;r++)if(t[r].settingUrl===e&&r!==a)return t[r]}function saveSettings(){let e=$(".settings-input #url").val(),t=pickr.getSelectedColor().toHEXA().toString(0),a=$(".settings-input #label").val(),r=$(".settings-input #font-size").val(),o=$(".settings-input #position").val(),l=$(".settings-input #size").val();""!==e&&""!==t&&""!==a?chrome.storage.sync.get(markersKey).then((i=>{let n=i[markersKey]||[];searchStoredMarkers(e,n)?showMessage(errorDuplicateMarker,!0):($(".alert-dismissible").length&&$(".alert-dismissible").alert("close"),$(".settings-input #url").val(""),$(".settings-input #label").val(""),$(".settings-input #font-size").val("14"),$(".settings-input #position").val("top-left"),$(".settings-input #size").val("normal"),storeSetting(i,e,t,a,o,l,r))}),onError):showMessage(""===a?errorLabelEmpty:errorUrlEmpty,!0)}function storeSetting(e,t,a,r,o,l,i){let n=e[markersKey]||[],s={settingUrl:t,settingColor:a,settingLabel:r,settingPosition:o,settingSize:l,settingFontSize:i};n.push(s);let c=n.length+1;chrome.storage.sync.set({[markersKey]:n}).then((()=>{showOrHideEmptyNotice(hide),displaySetting(c,t,a,r,o,l,i)}),onError)}function updateSetting(e,t,a,r,o,l,i,n,s){chrome.storage.sync.get(markersKey).then((c=>{let p=c[markersKey]||[],g=searchStoredMarkers(a,p,e);if(e=Number(e),g)showMessage(errorDuplicateMarker,!0);else{let c=p.filter((function(s,c){return s.settingUrl===t&&c===e&&(s.settingUrl=a,s.settingColor=r,s.settingLabel=o,s.settingFontSize=n,s.settingPosition=l,s.settingSize=i),!0}));chrome.storage.sync.set({[markersKey]:c}).then((()=>{displaySetting(e,a,r,o,l,i,n,s)}),onError)}}),onError)}function deleteSetting(e,t){chrome.storage.sync.get(markersKey).then((a=>{let r=a[markersKey]||[],o=searchStoredMarkers(e,r);if(t=Number(t),o){let a=r.filter((function(a,r){return a.settingUrl!==e&&r!==t}));chrome.storage.sync.set({[markersKey]:a}).then((()=>{showOrHideEmptyNotice()}),onError)}}),onError)}function clearAll(){$(".settings-container .setting").each(((e,t)=>{$(t).remove()})),chrome.storage.sync.set({[markersKey]:[]}).then(null,onError),showOrHideEmptyNotice(show)}function displaySetting(e,t,a,r,o,l,i,n=null){let s="14px";void 0!==i?s=fontSizeMap.reduce((function(e,t){return t.value===i&&(e=t.label),e}),{}):i="14";let c=positionsMap.reduce((function(e,t){return t.value===o&&(e=t.label),e}),{}),p=sizeSelectNormal;void 0!==l?p=sizesMap.reduce((function(e,t){return t.value===l&&(e=t.label),e}),{}):l="normal";let g=truncateString(t,30),h=he.encode(g),m=$("<div/>",{class:"setting"}),d=$("<div/>",{class:"my-1 align-items-center display-container"}),u='<div class="d-flex align-items-center"><div class="col-3 align-self-center"><b>'+truncateString(r,30)+'</b></div><div class="col-4 align-self-center">'+h+'</div> <div class="col-5 align-self-center">'+s+", "+p+" "+displayAt+" "+c+"</div> </div>",b=$("<div/>",{class:"col-10 display-labelUrl",tabindex:"0","aria-label":ariaLabelEditRibbon,"aria-pressed":"false","aria-controls":"edit-container-"+e,html:u,click:function(){d.hide(),k.show()}}),v=$("<div/>",{class:"col-1 display-color",tabindex:"0","aria-label":ariaLabelEditRibbon,"aria-pressed":"false","aria-controls":"edit-container-"+e,html:'<div class="display-color-color" style="background-color: '+a+';"></div>',click:function(){d.hide(),k.show()}}),S=$("<div/>",{class:"col-1 display-delete"}),y=$("<button/>",{class:"btn btn-danger btn-sm delete","aria-label":ariaLabelDeleteRibbon,html:'<i class="fas fa-trash fa-lg"></i>',click:function(){$(this).parent().parent().parent().remove(),deleteSetting(t,e)}}),k=$("<div/>",{class:"my-3 edit-container",id:"edit-container-"+e,style:"display: none;"}),f=$("<div/>",{class:"w-100 pe-1 edit-url-container"}),P=$("<input/>",{class:"form-control edit-url",placeholder:inputUrlFragmentPlaceholder,value:t}),M=$("<input/>",{type:"hidden",value:e}),w=$("<div/>",{class:"flex-shrink-1 px-1 edit-color"}),z=$("<input/>",{class:"color-picker",value:a}),E=$("<div/>",{class:"pe-1 edit-label-container"}),L=$("<input/>",{class:"form-control edit-label",placeholder:inputLabelPlaceholder,value:r}),B=$("<div/>",{class:"px-1 edit-font-size-container"}),_=$("<select/>",{class:"form-select edit-font-size"});for(let e=0;e<fontSizeMap.length;e++)fontSizeMap[e].value===i?_.append(new Option(fontSizeMap[e].label,fontSizeMap[e].value,!0,!0)):_.append(new Option(fontSizeMap[e].label,fontSizeMap[e].value));let A=$("<div/>",{class:"px-1 edit-position-container"}),x=$("<select/>",{class:"form-select edit-position"});for(let e=0;e<positionsMap.length;e++)positionsMap[e].value===o?x.append(new Option(positionsMap[e].label,positionsMap[e].value,!0,!0)):x.append(new Option(positionsMap[e].label,positionsMap[e].value));let C=$("<div/>",{class:"px-1 edit-size-container"}),K=$("<select/>",{class:"form-select edit-size"});for(let e=0;e<sizesMap.length;e++)sizesMap[e].value===l?K.append(new Option(sizesMap[e].label,sizesMap[e].value,!0,!0)):K.append(new Option(sizesMap[e].label,sizesMap[e].value));let R=$("<div/>",{class:"flex-shrink-1 ps-1 edit-update"}),U=$("<button/>",{class:"btn btn-success btn-sm update",html:'<i class="fas fa-pencil-alt fa-lg"></i>',click:function(){let e=M.val(),n=P.val(),s=z.val(),c=L.val(),p=_.val(),g=x.val(),h=K.val();n===t&&s===a&&c===r&&p===i&&g===o&&h===l||updateSetting(e,t,n,s,c,g,h,p,m)}}),O=$("<div/>",{class:"flex-shrink-1 ps-1 edit-cancel"}),N=$("<button/>",{class:"btn btn-secondary btn-sm cancel",html:'<i class="fas fa-times fa-lg"></i>',click:function(){d.show(),k.hide(),P.val(t),z.val(a),L.val(r),x.val(o),K.val(l),_.val(i)}}),D=$("<div/>",{class:"d-flex mb-2"}),F=$("<div/>",{class:"d-flex"});f.append(P),f.append(M),w.append(z),B.append(_),A.append(x),C.append(K),R.append(U),E.append(L),O.append(N),D.append(f),D.append(w),D.append(R),F.append(E),F.append(B),F.append(A),F.append(C),F.append(O),k.append(D),k.append(F),S.append(y),d.append(b),d.append(v),d.append(S),m.append(d),m.append(k),n?n.replaceWith(m):$(".settings-container").append(m),chrome.storage.sync.get(swatchesKey).then((e=>{e[swatchesKey]&&(colorSwatches=e[swatchesKey]);let t=Pickr.create({el:z[0],theme:"nano",default:a,useAsButton:!1,swatches:colorSwatches,components:{preview:!0,opacity:!0,hue:!0,interaction:{hex:!1,rgba:!1,hsla:!1,hsva:!1,cmyk:!1,input:!0,clear:!1,save:!0}},i18n:{"ui:dialog":colorPickerUiDialog,"btn:toggle":colorPickerBtnToggle,"btn:swatch":colorPickerBtnSwatch,"btn:last-color":colorPickerBtnLastColor,"btn:save":colorPickerBtnSave,"btn:cancel":colorPickerBtnCancel,"btn:clear":colorPickerBtnClear,"aria:btn:save":colorPickerAriaBtnSave,"aria:btn:cancel":colorPickerAriaBtnCancel,"aria:btn:clear":colorPickerAriaBtnClear,"aria:input":colorPickerAriaInput,"aria:palette":colorPickerAriaPalette,"aria:hue":colorPickerAriaHue,"aria:opacity":colorPickerAriaOpacity}});t.on("save",((e,a)=>{z.val(e.toHEXA().toString(0));let r=t.getSwatches();r.includes(e.toRGBA().toString(0))||(7===r.length&&r.pop(),r.unshift(e.toRGBA().toString(0)),t.setSwatches(r),saveSwatches(r)),a.hide()})),t.on("show",(()=>{chrome.storage.sync.get(swatchesKey).then((e=>{e[swatchesKey]&&(colorSwatches=e[swatchesKey]),t.setSwatches(colorSwatches)}),onError)}))}),onError)}Pickr.prototype.getSwatches=function(){return this._swatchColors.reduce(((e,t)=>(e.push(t.color.toRGBA().toString(0)),e)),[])},Pickr.prototype.setSwatches=function(e){if(e.length){for(let e=this._swatchColors.length-1;e>-1;e--)this.removeSwatch(e);e.forEach((e=>this.addSwatch(e)))}},$(document).ready((()=>{initialize(),$("html").attr("lang",languageCode);let e=$(".clear"),t=$(".toggle"),a=$(".options");$(".save").click((()=>{saveSettings()})),e.click((()=>{clearAll()})),a.click((()=>{chrome.runtime.openOptionsPage()})),t.click((()=>{chrome.storage.sync.get("__em-enabled__").then((e=>{let a=void 0===e["__em-enabled__"]||e["__em-enabled__"];chrome.storage.sync.set({"__em-enabled__":!a}).then((()=>{let e=a?buttonEnable:buttonDisable;t.html(e),t.attr("class",`btn btn-sm btn-${a?"success":"danger"} toggle`),chrome.runtime.sendMessage({cmd:"toggleExtensionOnOff",data:{value:!a}})}),onError)}),onError)})),chrome.storage.sync.get("__em-enabled__").then((e=>{let a=void 0===e["__em-enabled__"]||e["__em-enabled__"],r=a?buttonDisable:buttonEnable;t.html(r),t.attr("class",`btn btn-sm btn-${a?"danger":"success"} toggle`)}),onError),$(document).keydown((function(e){if("Enter"!==e.key&&"NumpadEnter"!==e.key||saveSettings(),"Escape"!==e.key)return!0;window.close()})),chrome.storage.sync.get(swatchesKey).then((e=>{e[swatchesKey]&&(colorSwatches=e[swatchesKey]),pickr=Pickr.create({el:".color-picker",theme:"nano",useAsButton:!1,swatches:colorSwatches,components:{preview:!0,opacity:!0,hue:!0,interaction:{hex:!1,rgba:!1,hsla:!1,hsva:!1,cmyk:!1,input:!0,clear:!1,save:!0}},i18n:{"ui:dialog":colorPickerUiDialog,"btn:toggle":colorPickerBtnToggle,"btn:swatch":colorPickerBtnSwatch,"btn:last-color":colorPickerBtnLastColor,"btn:save":colorPickerBtnSave,"btn:cancel":colorPickerBtnCancel,"btn:clear":colorPickerBtnClear,"aria:btn:save":colorPickerAriaBtnSave,"aria:btn:cancel":colorPickerAriaBtnCancel,"aria:btn:clear":colorPickerAriaBtnClear,"aria:input":colorPickerAriaInput,"aria:palette":colorPickerAriaPalette,"aria:hue":colorPickerAriaHue,"aria:opacity":colorPickerAriaOpacity}}),pickr.on("save",((e,t)=>{let a=pickr.getSwatches();a.includes(e.toRGBA().toString(0))||(7===a.length&&a.pop(),a.unshift(e.toRGBA().toString(0)),pickr.setSwatches(a),saveSwatches(a)),t.hide()})),pickr.on("show",(()=>{chrome.storage.sync.get(swatchesKey).then((e=>{e[swatchesKey]&&(colorSwatches=e[swatchesKey]),pickr.setSwatches(colorSwatches)}),onError)})),pickr.on("init",(e=>{$(".pcr-button").attr("tabindex","2")}))}),onError),$(".empty-notice").html(noticeNoRibbons),e.html(buttonClearAll),a.html(buttonOptions);let r=$("#url"),o=$("#color"),l=$("#label");chrome.storage.sync.get(searchModeKey).then((e=>{e[searchModeKey]||!1?(r.attr("placeholder",inputUrlFragmentRegExpPlaceholder),r.attr("aria-label",inputUrlFragmentRegExpPlaceholder)):(r.attr("placeholder",inputUrlFragmentPlaceholder),r.attr("aria-label",inputUrlFragmentPlaceholder))})),o.attr("placeholder",inputColorPlaceholder),o.attr("aria-label",inputColorPlaceholder),l.attr("placeholder",inputLabelPlaceholder),l.attr("aria-label",inputLabelPlaceholder),$("#font-size").attr("aria-label",selectFontSizeLabel),$("#position").attr("aria-label",selectPositionLabel),$("#size").attr("aria-label",selectRibbonSizeLabel),$("#save").attr("aria-label",buttonSaveLabel),$('#position option[value="top-left"]').html(positionSelectTopLeft),$('#position option[value="top-right"]').html(positionSelectTopRight),$('#position option[value="bottom-left"]').html(positionSelectBottomLeft),$('#position option[value="bottom-right"]').html(positionSelectBottomRight),$('#size option[value="extra-small"]').html(sizeSelectExtraSmall),$('#size option[value="small"]').html(sizeSelectSmall),$('#size option[value="normal"]').html(sizeSelectNormal),$('#size option[value="large"]').html(sizeSelectLarge),$('#size option[value="extra-large"]').html(sizeSelectExtraLarge)}));