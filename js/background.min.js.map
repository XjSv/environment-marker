{"version":3,"file":"background.min.js","names":["TAB_COUNT_COLOR_LIMIT","TAB_COUNT_COLOR_LOW","TAB_COUNT_COLOR_HIGH","extensionEnabledKey","markersKey","searchModeKey","tabCounterKey","faviconMarkerKey","fontKey","onError","error","console","log","updateCount","tabId","isOnRemoved","chrome","storage","sync","get","then","storedTabCounter","tabs","query","length","map","t","id","includes","action","setBadgeText","text","toString","setBadgeBackgroundColor","color","clearCount","updateContent","undefined","tab","url","options","fontString","searchModeRegExp","faviconMarker","storedObject","urlFound","RegExp","settingUrl","test","indexOf","scripting","executeScript","target","files","sendMessage","command","settingColor","label","settingLabel","fontSize","settingFontSize","position","settingPosition","size","settingSize","font","enableFaviconMarker","response","catch","insertCSS","extensionEnabledValue","initialize","runtime","onMessage","addListener","request","sender","sendResponse","cmd","set","data","value","removeListeners","onRemovedListener","removeInfo","onCreatedListener","onUpdatedListener","changeInfo","status","onRemoved","onCreated","onUpdated","removeListener"],"sources":["background.js"],"sourcesContent":["const TAB_COUNT_COLOR_LIMIT = 10;\r\nconst TAB_COUNT_COLOR_LOW = '#28a745';\r\nconst TAB_COUNT_COLOR_HIGH ='#dc3545';\r\nconst extensionEnabledKey = '__em-enabled__';\r\nconst markersKey = '__em-markers__';\r\nconst searchModeKey = '__em-search-mode__';\r\nconst tabCounterKey = '__em-tab-counter__';\r\nconst faviconMarkerKey = '__em-favicon-marker__';\r\nconst fontKey = '__em-font__';\r\n\r\n// Generic Error Handler\r\nfunction onError(error) {\r\n  console.log(error);\r\n}\r\n\r\nchrome.storage.sync.get(extensionEnabledKey).then((extensionEnabledValue) => {\r\n  let extensionEnabled = extensionEnabledValue[extensionEnabledKey] === undefined ? true : extensionEnabledValue[extensionEnabledKey];\r\n  if (extensionEnabled) {\r\n    initialize();\r\n  }\r\n}, onError);\r\n\r\nchrome.runtime.onMessage.addListener(\r\n  function (request, sender, sendResponse) {\r\n    if (request.cmd === \"toggleExtensionOnOff\") {\r\n      chrome.storage.sync.set({ [extensionEnabledKey] :  request.data.value }).then(() => {\r\n        if (request.data.value) {\r\n          initialize();\r\n        } else {\r\n          removeListeners();\r\n        }\r\n      }, onError);\r\n    }\r\n  }\r\n);\r\n\r\nfunction updateCount(tabId, isOnRemoved) {\r\n  chrome.storage.sync.get(tabCounterKey).then((storedTabCounter) => {\r\n    let storedTabCounterBool = storedTabCounter[tabCounterKey] || false;\r\n\r\n    if (storedTabCounterBool) {\r\n      chrome.tabs.query({}).then((tabs) => {\r\n        let length = tabs.length;\r\n\r\n        // onRemoved fires too early and the count is one too many.\r\n        // see https://bugzilla.mozilla.org/show_bug.cgi?id=1396758\r\n        if (isOnRemoved && tabId && tabs.map((t) => { return t.id; }).includes(tabId)) {\r\n          length--;\r\n        }\r\n\r\n        chrome.action.setBadgeText({ text: length.toString() });\r\n\r\n        if (length > TAB_COUNT_COLOR_LIMIT) {\r\n          chrome.action.setBadgeBackgroundColor({ 'color': TAB_COUNT_COLOR_HIGH });\r\n        } else {\r\n          chrome.action.setBadgeBackgroundColor({ 'color': TAB_COUNT_COLOR_LOW });\r\n        }\r\n      });\r\n    } else {\r\n      chrome.action.setBadgeText({ text: '' });\r\n    }\r\n  });\r\n}\r\n\r\nfunction clearCount() {\r\n  chrome.action.setBadgeText({ text: '' });\r\n}\r\n\r\nfunction updateContent(tabId) {\r\n  if (tabId !== undefined) {\r\n    chrome.tabs.get(tabId).then((tab) => {\r\n      if (tab.url !== '') {\r\n        chrome.storage.sync.get([\r\n          fontKey,\r\n          searchModeKey,\r\n          markersKey,\r\n          faviconMarkerKey\r\n        ]).then((options) => {\r\n          let fontString = options[fontKey] || '';\r\n          let searchModeRegExp = options[searchModeKey] || false;\r\n          let faviconMarker = options[faviconMarkerKey] || false;\r\n\r\n          if (options[markersKey]) {\r\n            for (let storedObject of options[markersKey]) {\r\n\r\n              let urlFound = false;\r\n              if (searchModeRegExp) {\r\n                let regex = new RegExp(storedObject.settingUrl, 'iu');\r\n                urlFound = regex.test(tab.url);\r\n              } else {\r\n                urlFound = (tab.url.indexOf(storedObject.settingUrl) !== -1);\r\n              }\r\n\r\n              // Issue #233 (Add IP Restriction)\r\n              // https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/dns/resolve\r\n              /* let searchModeDns = false;\r\n\r\n              if (searchModeDns) {\r\n                console.log(tab);\r\n\r\n                const url = new URL(tab.url);\r\n                const domain = url.hostname;\r\n\r\n                console.log(domain);\r\n\r\n                let resolving = browser.dns.resolve(domain);\r\n                resolving.then(resolved);\r\n              } */\r\n\r\n              if (urlFound) {\r\n                chrome.scripting.executeScript({\r\n                  target: {\r\n                    tabId: tabId\r\n                  },\r\n                  files: ['/js/content.min.js']\r\n                }).then(() => {\r\n                  chrome.tabs.sendMessage(tabId, {\r\n                    command: 'addRibbon',\r\n                    url: storedObject.settingUrl,\r\n                    color: storedObject.settingColor,\r\n                    label: storedObject.settingLabel,\r\n                    fontSize: storedObject.settingFontSize,\r\n                    position: storedObject.settingPosition,\r\n                    size: storedObject.settingSize,\r\n                    font: fontString,\r\n                    enableFaviconMarker: faviconMarker,\r\n                  }).then((response) => {\r\n                    /* if (response !== undefined) {\r\n                      console.log(\"Message from the content script:\");\r\n                      console.log(response);\r\n                    } */\r\n                  }).catch(onError);\r\n                }, onError);\r\n\r\n                chrome.scripting.insertCSS({\r\n                  target: {\r\n                    tabId: tabId,\r\n                  },\r\n                  files: [ '/css/content.min.css' ],\r\n                }).then(null, onError);\r\n              }\r\n            }\r\n          }\r\n        });\r\n      }\r\n    }, onError);\r\n  }\r\n}\r\n\r\nlet onRemovedListener = function(tabId, removeInfo) {\r\n  updateCount(tabId, true);\r\n};\r\n\r\nlet onCreatedListener = function(tab) {\r\n  updateCount(tab.id, false);\r\n};\r\nlet onUpdatedListener = function(tabId, changeInfo, tab) {\r\n  // Only run update once after the page is finished loading\r\n  if (changeInfo.status === 'complete') {\r\n    updateContent(tabId);\r\n  }\r\n};\r\n\r\nfunction initialize() {\r\n  chrome.tabs.onRemoved.addListener(onRemovedListener);\r\n  chrome.tabs.onCreated.addListener(onCreatedListener);\r\n  chrome.tabs.onUpdated.addListener(onUpdatedListener);\r\n  updateCount();\r\n}\r\n\r\nfunction removeListeners() {\r\n  chrome.tabs.onRemoved.removeListener(onRemovedListener);\r\n  chrome.tabs.onCreated.removeListener(onCreatedListener);\r\n  chrome.tabs.onUpdated.removeListener(onUpdatedListener);\r\n  clearCount();\r\n}\r\n"],"mappings":"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"}