{"version":3,"sources":["background.js"],"names":["TAB_COUNT_COLOR_LIMIT","TAB_COUNT_COLOR_LOW","TAB_COUNT_COLOR_HIGH","markersKey","searchModeKey","fontKey","onError","error","console","log","updateCount","tabId","isOnRemoved","browser","tabs","query","then","length","map","t","id","includes","browserAction","setBadgeText","text","toString","setBadgeBackgroundColor","color","updateContent","undefined","get","tab","url","storage","local","storedArray","storedSearchMode","searchModeRegExp","storedObject","urlFound","RegExp","settingUrl","test","indexOf","storedFont","fontString","executeScript","file","sendMessage","command","settingColor","label","settingLabel","fontSize","settingFontSize","position","settingPosition","size","settingSize","font","response","catch","insertCSS","onRemoved","addListener","removeInfo","onCreated","onUpdated","changeInfo","status"],"mappings":"AAAA,MAAMA,sBAAwB,GACxBC,oBAAsB,UACtBC,qBAAsB,UACtBC,WAAa,iBACbC,cAAgB,qBAChBC,QAAU,cAGhB,SAASC,QAAQC,GACfC,QAAQC,IAAIF,GAGd,SAASG,YAAYC,EAAOC,GAC1BC,QAAQC,KAAKC,MAAM,IAAIC,KAAMF,IAC3B,IAAIG,EAASH,EAAKG,OAIdL,GAAeD,GAASG,EAAKI,IAAKC,GAAeA,EAAEC,IAAOC,SAASV,IACnEM,IAGJJ,QAAQS,cAAcC,aAAa,CAAEC,KAAMP,EAAOQ,aAE9CR,EAxBsB,GAyBtBJ,QAAQS,cAAcI,wBAAwB,CAAEC,MAvB5B,YAyBpBd,QAAQS,cAAcI,wBAAwB,CAAEC,MA1B5B,cA+B5B,SAASC,cAAcjB,QACPkB,IAAVlB,GACFE,QAAQC,KAAKgB,IAAInB,GAAOK,KAAMe,IACZ,KAAZA,EAAIC,KACNnB,QAAQoB,QAAQC,MAAMJ,IAAI3B,YAAYa,KAAMmB,IAC1CtB,QAAQoB,QAAQC,MAAMJ,IAAI1B,eAAeY,KAAMoB,IAE7C,IAAIC,EAAmBD,EAAiBhC,iBAAkB,EAC1D,GAAI+B,EAAYhC,YAEd,IAAK,IAAImC,KAAgBH,EAAYhC,YAAa,CAEhD,IAAIoC,GAAW,EACf,GAAIF,EAAkB,CAEpBE,EADY,IAAIC,OAAOF,EAAaG,WAAY,MAC/BC,KAAKX,EAAIC,UAE1BO,GAA0D,IAA9CR,EAAIC,IAAIW,QAAQL,EAAaG,YAGvCF,GACF1B,QAAQoB,QAAQC,MAAMJ,IAAIzB,SAASW,KAAM4B,IACvC,IAAIC,EAAaD,EAAWvC,UAAY,GAExCQ,QAAQC,KAAKgC,cAAcnC,EAAO,CAChCoC,KAAM,uBACL/B,KAAK,KACNH,QAAQC,KAAKkC,YAAYrC,EAAO,CAC9BsC,QAAS,YACTjB,IAAKM,EAAaG,WAClBd,MAAOW,EAAaY,aACpBC,MAAOb,EAAac,aACpBC,SAAUf,EAAagB,gBACvBC,SAAUjB,EAAakB,gBACvBC,KAAMnB,EAAaoB,YACnBC,KAAMd,IACL7B,KAAK4C,OAGLC,MAAMvD,UACRA,SAEHO,QAAQC,KAAKgD,UAAUnD,EAAO,CAC5BoC,KAAM,yBACL/B,KAAK,KAAMV,aAKrBA,UACFA,UAEJA,SAIPO,QAAQC,KAAKiD,UAAUC,YAAY,CAACrD,EAAOsD,KACzCvD,YAAYC,GAAO,KAGrBE,QAAQC,KAAKoD,UAAUF,YAAajC,IAClCrB,YAAYqB,EAAIX,IAAI,KAGtBP,QAAQC,KAAKqD,UAAUH,YAAY,CAACrD,EAAOyD,EAAYrC,KAE3B,aAAtBqC,EAAWC,QACbzC,cAAcjB,KAIlBD","file":"background.min.js","sourcesContent":["const TAB_COUNT_COLOR_LIMIT = 10;\r\nconst TAB_COUNT_COLOR_LOW = '#28a745';\r\nconst TAB_COUNT_COLOR_HIGH ='#dc3545';\r\nconst markersKey = '__em-markers__';\r\nconst searchModeKey = '__em-search-mode__';\r\nconst fontKey = '__em-font__';\r\n\r\n/* generic error handler */\r\nfunction onError(error) {\r\n  console.log(error);\r\n}\r\n\r\nfunction updateCount(tabId, isOnRemoved) {\r\n  browser.tabs.query({}).then((tabs) => {\r\n    let length = tabs.length;\r\n\r\n    // onRemoved fires too early and the count is one too many.\r\n    // see https://bugzilla.mozilla.org/show_bug.cgi?id=1396758\r\n    if (isOnRemoved && tabId && tabs.map((t) => { return t.id; }).includes(tabId)) {\r\n        length--;\r\n    }\r\n\r\n    browser.browserAction.setBadgeText({ text: length.toString() });\r\n\r\n    if (length > TAB_COUNT_COLOR_LIMIT) {\r\n        browser.browserAction.setBadgeBackgroundColor({ 'color': TAB_COUNT_COLOR_HIGH });\r\n    } else {\r\n        browser.browserAction.setBadgeBackgroundColor({ 'color': TAB_COUNT_COLOR_LOW });\r\n    }\r\n  });\r\n}\r\n\r\nfunction updateContent(tabId) {\r\n  if (tabId !== undefined) {\r\n    browser.tabs.get(tabId).then((tab) => {\r\n      if (tab.url !== '') {\r\n        browser.storage.local.get(markersKey).then((storedArray) => {\r\n          browser.storage.local.get(searchModeKey).then((storedSearchMode) => {\r\n\r\n            let searchModeRegExp = storedSearchMode[searchModeKey] || false;\r\n            if (storedArray[markersKey]) {\r\n\r\n              for (let storedObject of storedArray[markersKey]) {\r\n\r\n                let urlFound = false;\r\n                if (searchModeRegExp) {\r\n                  let regex = new RegExp(storedObject.settingUrl, 'iu');\r\n                  urlFound = regex.test(tab.url);\r\n                } else {\r\n                  urlFound = (tab.url.indexOf(storedObject.settingUrl) !== -1);\r\n                }\r\n\r\n                if (urlFound) {\r\n                  browser.storage.local.get(fontKey).then((storedFont) => {\r\n                    let fontString = storedFont[fontKey] || '';\r\n\r\n                    browser.tabs.executeScript(tabId, {\r\n                      file: '/js/content.min.js'\r\n                    }).then(() => {\r\n                      browser.tabs.sendMessage(tabId, {\r\n                        command: 'addRibbon',\r\n                        url: storedObject.settingUrl,\r\n                        color: storedObject.settingColor,\r\n                        label: storedObject.settingLabel,\r\n                        fontSize: storedObject.settingFontSize,\r\n                        position: storedObject.settingPosition,\r\n                        size: storedObject.settingSize,\r\n                        font: fontString\r\n                      }).then(response => {\r\n                        //console.log(\"Message from the content script:\");\r\n                        //console.log(response.response);\r\n                      }).catch(onError);\r\n                    }, onError);\r\n\r\n                    browser.tabs.insertCSS(tabId, {\r\n                      file: '/css/content.min.css'\r\n                    }).then(null, onError);\r\n                  });\r\n                }\r\n              }\r\n            }\r\n          }, onError);\r\n        }, onError);\r\n      }\r\n    }, onError);\r\n  }\r\n}\r\n\r\nbrowser.tabs.onRemoved.addListener((tabId, removeInfo) => {\r\n  updateCount(tabId, true);\r\n});\r\n\r\nbrowser.tabs.onCreated.addListener((tab) => {\r\n  updateCount(tab.id, false);\r\n});\r\n\r\nbrowser.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {\r\n  // Only run update once after the page is finished loading\r\n  if (changeInfo.status === 'complete') {\r\n    updateContent(tabId);\r\n  }\r\n});\r\n\r\nupdateCount();\r\n"]}